# 산사태위험지도

## 연구질문

1. 산불피해 지역의 면적이 산사태 발생에 미치는 영향은 어느 정도인가?
2. 시계열 InSAR 분석 결과가 국내 산사태 예측 개선에 유의미한가?
3. 새로운 분석 방법(모델)과 데이터 도입으로 산사태 위험지도의 정확도를 높일 수 있는가?

## 연구 개요 및 목표

### 연구 목표
Sentinel-1 InSAR 기반 지반 취약 상태와 n일 윈도우 기상, 토양 정보를 결합해 산사태 위험지도를 주기적으로 업데이트

### 연구 배경 및 필요성
- 기존 산림청 산사태 위험지도는 9개 인자를 사용하나 동적 정보 반영 한계 → 인자 확장 및 실시간 업데이트 필요
- 산불 이력과 InSAR 변위정보를 추가해 정확성 강화
- Sentinel-1 주기적 관측(6일/12일)으로 신속한 변화 반영

### 방법론
- 산사태 발생 시점 2~4개월 내 데이터 활용(pair 구성)
- **정적 데이터:** 토지피복도, 임상도, 지질도, DEM 기반 수문인자, 산불 발생 이력
- **동적 데이터:** 5일 누적강우, 일일 peak1h 강우, InSAR 변위량
- DEM 해상도(30m)로 모든 인자 보정, 픽셀 단위 산사태 위험도 산출(1~5등급)

### 난관 및 해결 방안
- **데이터 정합:** 모든 픽셀 격자를 DEM 기준(30m)으로 통일
- **산사태/산불 이력 좌표 데이터를 공간 데이터로 변환,** 사면 단위 기준 산출
- **SAR coherence/intensity 차이 기반 산사태 발생지 레이블링 방법 개발**
- **다양한 주기(시간 해상도) 데이터 통합**
- **예측 단위:** 사면 단위

### 데이터 처리 규칙
- **프로젝트 좌표계** EPSG:4326 (작업 시 5179로 정합)

#### 산사태 라벨링 기준
- 산사태 발생일 dNDVI, dNBR 활용
- 경사도 임계값
- SAR coherence 변화량
- InSAR 데이터
- 사면 단위 변환(아래 grass GIS slope labeling 참고)

#### 산불 데이터 수집 및 처리
- **BAI(Burned Area Index) 추가 도입:** dNBR, dNDVI 외에 BAI 지수 활용
- **데이터 수집 스크립트:** `D:\Landslide\data\utils\s2_l2a_search_from_fire_csv.py`
- **수집 조건:**
  - 산불 진화 시점 기준 15일 간 검색 윈도우
  - 구름 피복율 40% 이하 조건
  - 조건 만족하는 영상 중 best 선택 (최저 구름율)
  - 사건-영상 pair 구성하여 각 영상의 BAI 계산 예정

---

## 산사태 유발 변수

- **지형:** 고도, 경사, 경사방향, 곡률 등
- **기상:** 강우량, 집중호우, 강우량 증가 등
- **토양/지질:** 암석 유형, 지질구조, 토양특성(유형, 침투성, 수분)
- **식생/이용:** 토지피복, 식생지수
- **수문:** 누적강우, 강우특성, 지하수위, 토양수분
- **산불 관련:** 과거 산불 발생 이력, BAI(Burned Area Index), dNBR, dNDVI
- **기타:** 과거 산사태 이력, InSAR 변위정보

---

## 주요 데이터 소스

- **강수:** 기상청 기상자료공개포털(전국 AWS 등)
- **지질:** 국토기본지질도, 광역지질도, 한국지질도
- **InSAR 변위:** Sentinel-1
- **식생 지수:** Sentinel-2 (NDVI, BAI, dNBR 등)
- **산불 영향 분석:** Sentinel-2 L2A (Copernicus Data Space)
- **DEM:** 국가지리정보원(90m 무료, 5m 별도 요청)

### slope unit(사면단위) 라벨 생성 요약

#### DEM 기반 경사면 파생
- DEM(디지털 표고모델) 30m 해상도 기반으로 경사(slope), 방위(aspect), 만곡(curvature) 등 파생 지형요소를 생성
- 사면단위 내 평균 cos(방위), sin(방위) 통계로 방향성 일관성(R²) 평가
- GRASS GIS `r.slopeunits.create` 이용

#### 사면단위(Slope Unit) 분할
- `r.slopeunits.create` 명령에서 임계(thresh), 최소면적(areamin), 일관성(cvmin) 등 주요 파라미터로 자동 분할
- 이후 래스터→폴리곤화, 소구역 제거, 면적·콤팩트도·방위 일관성 등 속성 부여

#### 라벨링 기준
- 공식 산사태 위치(포인트) 30m/60m 버퍼 생성, SU(사면단위)와 공간 교집합 연산해 접촉 면적 비율(분수) 산출
- 임계값(예: 0.1%, 0.5%) 초과 시 양성(SU)으로 라벨링(존재기반/soft label 포함)
- 픽셀·사면단위 별 soft label 생성 시 거리 기반 감쇠(예: 60m에서 지수 함숫값)

#### 최적화 및 품질관리
- SU 면적 중앙값/방위 일관성(R²) 통계로 파라미터 튜닝 및 SU 품질 관리
- 벡터(GPKG)/래스터/CSV로 최종 산출 및 모델 개발에 바로 활용

---

## 세부사항/데이터 구조

- 모든 데이터는 SRTM DEM 30m 해상도 기준 처리
- 정적요소(지형·지질·토지피복 등)와 동적요소(강우, InSAR 변위)로 구분하여 모델링 입력
- 정적 데이터로 지형 및 산사태 조건/상태, 동적 데이터로 trigger event 추적

## 모델 구조 및 아이디어

- **아이디어1:** 정적 데이터+장기간 데이터를 메인 학습, 최근 이벤트/데이터를 주기적으로 추가(fine tuning)
- **아이디어2:** 동적 데이터 주기별 분리하여 별도 입력 채널 운영
- **아이디어3:** 산사태 요인 시간적으로 단기/장기 분리해 분석·모델 학습
- **아이디어4:** InSAR 인자 단기(2-4개월)·장기 데이터 동시에 투입

## 주요 쟁점

- InSAR 변위 stack(시계열)이 산사태 예측에 실제 얼마나 효과적인가?
- 산불 피해 후 산사태 위험 증가 상관관계와 식생 회복 과정의 위험 변화 분석 필요
- 메인 모델의 데이터 stack/fusion 전략 (pair 설계 등)

## 참조 링크
- grass Slope labeling

## 참고 수식(모델)
- 산사태 발생 확률(PLandslide | terrain, rainfall 등) 관련 통계/수식 모델 (본문 내 수식 참조)

---

## 라벨링

### Sentinel-1 데이터 누락 및 관측지역 변화 이슈
- 2019/01/04 ~ 2019/06/21: 12일 간격 데이터 존재
- 06/21~08/08: 결측
- 06/21 scene: azimuth 폭 절반
- 08/08, 08/20: 궤도 변화로 관측지역 위로 이동
- 12/18, 12/30, 2020/01/11 ~ 2020/02/28: 결측, 03/11부터 다시 존재
- 2020/05/10, 05/22, 06/03, 06/15: 강원도 결측
- 2020/08/02: 강원도 결측
- 2020/11/30: 중부·강원도 결측
- 2021/05/29, 06/10: 강원도 결측
- 2021/06/22: 강원도·중부 결측
- 2021/08/09: 결측
- 2022/03/13: 중부 절반 짤림
- 2022/05/12: 결측
- 2022/05/24: 중부·강원 결측
- 2022/08/04, 08/28: 중부 절반 짤림
- 2022/09/09: 궤도 변화
- 2022/09/21, 10/03: 중부 중간 짤림
- 2022/11/20: 중부 중간짤림
- 2022/12/14, 12/26: 중부 중간짤림
- 2023/01/07: 중부 결측

---

## 모델
- 산사태 발생 확률 모델링 수식 등(노션 원문 MathML 기반)

---

---

## 2020 산사태 (경상도 지역 주요 발생일)
- 06/12
- 06/29
- 07/12
- 07/23
- 07/28 (엄청많음)
- 09/01 (엄청많음)

---

## 좌표 데이터 출처
- 산사태 발생 이력 좌표 데이터: https://www.safemap.go.kr/main/smap.do?flag=2

---

## 시스템 구성요소

### 1. 전처리 및 특징화
- JS-InSAR를 활용하여 식생 및 산악지역에서 측정점 밀도 최대화
- 촬영일 기준으로 라그(1-21일), API, 토양수분을 정렬
- 강우-토양수분-변형의 10-22일 지연관계 학습

### 2. 상태 추정 엔진
- InSAR 저빈도 시계열과 일별 수문 변수 결합
- 일 단위 상태 벡터 산출 (속도, 가속도, coherence 포함)

### 3. 사건 반영 로직
- 촬영 간격 동안 실시간/예보 강우 및 토양수분 데이터 활용
- Baseline Risk(상태)를 Dynamic Factor(사건)로 보정
- 조건부 경보 확률과 리드타임(1-5일) 산출

### 4. 출력
- 한국 몬순 조건에서 동적 산사태 위험지도 (6/12일 갱신 + 중간일 실시간 조정)
- 확률기반 다단계 경보 (주의/경계/심각/긴급)

## 조건부 확률 모델

### 1. 기본 위험도 모델링
- Sentinel-1 위성 12일 주기에 맞춰 지반 침하 및 취약 상태 평가
- 과거 1-21일 누적 강우 및 토양 수분 정보를 입력으로 활용
- P(산사태|지반상태) 확률 모델링

### 2. 동적 위험도 조절 모델링
- 위성 관측 공백기간 중 돌발 기상 변화 대응
- 실시간 기상 데이터 활용 (강우강도, 지속시간, 임계값 초과 여부)
- 기본 위험도 모델과 결합하여 최종 산사태 위험 지도 생성

### 3. 모델 검증
- 실제 산사태 발생 이력과 비교
- AUC, POD 등 성능 지표 활용

## 연구 난관 및 과제

### 1. 이력 자료 변환
- **문제점**: 산사태 및 산불 이력 자료가 csv(좌표)로 제공
- **과제**: 공간정보데이터로 변환 작업 필요

### 2. 광학영상 취득 곤란   
- **문제점**: 각 이벤트 전‧후 광학영상 확보 어려움
- **과제**: 대체 데이터 소스 및 분석 방법 모색

### 3. Labeling 정확도
- **문제점**: SAR의 coherence, intensity 차이 기반 산사태 발생 지역 레이블링의 정확도 문제
- **과제**: 레이블링 구축방안 개선 및 검증 방법 마련

### 4. 시계열 데이터 통합
- **문제점**: 서로 다른 주기를 가진 데이터(기상, SAR 등)의 통합 어려움
- **과제**: 다양한 주기의 데이터를 모델에 통합·학습시키는 방법론 개발

### 5. 산사태 - 산불 인과분석
- **문제점**: 산불과 산사태의 영향 관계를 시간선으로 분석 필요함
- **과제**: 해당 데이터가 공간정보데이터로 제공되지 않기 때문에 당장 인과분석을 하기가 어려워, 모델의 입력에 넣는 타당성을 확보하기 어려움

## 데이터 수집 및 처리

### LDAPS 기상 데이터

#### 개요
- **LDAPS (Limited area Data Assimilation and Prediction System)**: 기상청 국지예보모델
- **공간 해상도**: 1.5km 격자
- **시간 해상도**: 1시간 간격
- **예보 범위**: 48시간 선행시간

#### 데이터 수집
```bash
# conda 환경 설정
conda env create -f environment_ldaps.yml
conda activate ldaps

# LDAPS 강수량 데이터 다운로드
python data/LDAPS/ldaps_load_grib.py
```

#### 처리 과정
1. **GRIB2 다운로드**: KMA Open API를 통한 원본 기상 데이터 수집
2. **지역 마스킹**: 대상 지역 (경남·경북·대구·울산·부산) 추출
3. **NetCDF 변환**: 분석 가능한 격자 데이터로 변환
4. **시계열 구성**: 24시간 연속 데이터로 재구성

#### 출력 파일
- **GRIB 원본**: `data/LDAPS/GRIB/l015_YYYYMMDDHHMM_lspr_h000.gb2`
- **NetCDF 처리본**: `data/LDAPS/NetCDF/LDAPS_Rain_YYYYMMDD.nc`

#### 환경변수 설정
```bash
# KMA API 키 설정 (필수)
set KMA_SERVICE_KEY=your_api_key_here
```

### 위성 데이터 (예정)
- **Sentinel-1 SAR**: InSAR 변위 측정
- **처리 주기**: 6/12일 간격
- **공간 해상도**: 20m

### 지형 데이터 (예정)
- **DEM**: 수치표고모델
- **경사도**: 사면 안정성 분석
- **토지이용**: 식생 및 개발 현황

